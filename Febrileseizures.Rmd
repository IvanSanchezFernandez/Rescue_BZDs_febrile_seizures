
# Rescue benzodiazepines after febrile seizures








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("DescTools")
library(DescTools)

# install.packages("ggplot2")
library(ggplot2)

# install.packages("plotly")
library(plotly)

# install.packages("survival")
library(survival)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "D:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2006
ms_i_2006 <- tbl(MarketScan, "ms_i_2006")
ms_s_2006 <- tbl(MarketScan, "ms_s_2006")
ms_d_2006 <- tbl(MarketScan, "ms_d_2006")
ms_o_2006 <- tbl(MarketScan, "ms_o_2006")
ms_a_2006 <- tbl(MarketScan, "ms_a_2006")
ms_t_2006 <- tbl(MarketScan, "ms_t_2006")
redbook_2006 <- tbl(MarketScan, "redbook_2006")

# Year 2007
ms_i_2007 <- tbl(MarketScan, "ms_i_2007")
ms_s_2007 <- tbl(MarketScan, "ms_s_2007")
ms_d_2007 <- tbl(MarketScan, "ms_d_2007")
ms_o_2007 <- tbl(MarketScan, "ms_o_2007")
ms_a_2007 <- tbl(MarketScan, "ms_a_2007")
ms_t_2007 <- tbl(MarketScan, "ms_t_2007")
redbook_2007 <- tbl(MarketScan, "redbook_2007")

# Year 2008
ms_i_2008 <- tbl(MarketScan, "ms_i_2008")
ms_s_2008 <- tbl(MarketScan, "ms_s_2008")
ms_d_2008 <- tbl(MarketScan, "ms_d_2008")
ms_o_2008 <- tbl(MarketScan, "ms_o_2008")
ms_a_2008 <- tbl(MarketScan, "ms_a_2008")
ms_t_2008 <- tbl(MarketScan, "ms_t_2008")
redbook_2008 <- tbl(MarketScan, "redbook_2008")

# Year 2009
ms_i_2009 <- tbl(MarketScan, "ms_i_2009")
ms_s_2009 <- tbl(MarketScan, "ms_s_2009")
ms_d_2009 <- tbl(MarketScan, "ms_d_2009")
ms_o_2009 <- tbl(MarketScan, "ms_o_2009")
ms_a_2009 <- tbl(MarketScan, "ms_a_2009")
ms_t_2009 <- tbl(MarketScan, "ms_t_2009")
redbook_2009 <- tbl(MarketScan, "redbook_2009")

# Year 2010
ms_i_2010 <- tbl(MarketScan, "ms_i_2010")
ms_s_2010 <- tbl(MarketScan, "ms_s_2010")
ms_d_2010 <- tbl(MarketScan, "ms_d_2010")
ms_o_2010 <- tbl(MarketScan, "ms_o_2010")
ms_a_2010 <- tbl(MarketScan, "ms_a_2010")
ms_t_2010 <- tbl(MarketScan, "ms_t_2010")
redbook_2010 <- tbl(MarketScan, "redbook_2010")

# Year 2011
ms_i_2011 <- tbl(MarketScan, "ms_i_2011")
ms_s_2011 <- tbl(MarketScan, "ms_s_2011")
ms_d_2011 <- tbl(MarketScan, "ms_d_2011")
ms_o_2011 <- tbl(MarketScan, "ms_o_2011")
ms_a_2011 <- tbl(MarketScan, "ms_a_2011")
ms_t_2011 <- tbl(MarketScan, "ms_t_2011")
redbook_2011 <- tbl(MarketScan, "redbook_2011")

# Year 2012
ms_i_2012 <- tbl(MarketScan, "ms_i_2012")
ms_s_2012 <- tbl(MarketScan, "ms_s_2012")
ms_d_2012 <- tbl(MarketScan, "ms_d_2012")
ms_o_2012 <- tbl(MarketScan, "ms_o_2012")
ms_a_2012 <- tbl(MarketScan, "ms_a_2012")
ms_t_2012 <- tbl(MarketScan, "ms_t_2012")
redbook_2012 <- tbl(MarketScan, "redbook_2012")

# Year 2013
ms_i_2013 <- tbl(MarketScan, "ms_i_2013")
ms_s_2013 <- tbl(MarketScan, "ms_s_2013")
ms_d_2013 <- tbl(MarketScan, "ms_d_2013")
ms_o_2013 <- tbl(MarketScan, "ms_o_2013")
ms_a_2013 <- tbl(MarketScan, "ms_a_2013")
ms_t_2013 <- tbl(MarketScan, "ms_t_2013")
redbook_2013 <- tbl(MarketScan, "redbook_2013")

# Year 2014
ms_i_2014 <- tbl(MarketScan, "ms_i_2014")
ms_s_2014 <- tbl(MarketScan, "ms_s_2014")
ms_d_2014 <- tbl(MarketScan, "ms_d_2014")
ms_o_2014 <- tbl(MarketScan, "ms_o_2014")
ms_a_2014 <- tbl(MarketScan, "ms_a_2014")
ms_t_2014 <- tbl(MarketScan, "ms_t_2014")
redbook_2014 <- tbl(MarketScan, "redbook_2014")

# Year 2015
ms_i_2015 <- tbl(MarketScan, "ms_i_2015")
ms_s_2015 <- tbl(MarketScan, "ms_s_2015")
ms_d_2015 <- tbl(MarketScan, "ms_d_2015")
ms_o_2015 <- tbl(MarketScan, "ms_o_2015")
ms_a_2015 <- tbl(MarketScan, "ms_a_2015")
ms_t_2015 <- tbl(MarketScan, "ms_t_2015")
redbook_2015 <- tbl(MarketScan, "redbook_2015")

# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")

# Year 2020
ms_i_2020 <- tbl(MarketScan, "ms_i_2020")
ms_s_2020 <- tbl(MarketScan, "ms_s_2020")
ms_d_2020 <- tbl(MarketScan, "ms_d_2020")
ms_o_2020 <- tbl(MarketScan, "ms_o_2020")
ms_a_2020 <- tbl(MarketScan, "ms_a_2020")
ms_t_2020 <- tbl(MarketScan, "ms_t_2020")
redbook_2020 <- tbl(MarketScan, "redbook_2020")

# Year 2021
ms_i_2021 <- tbl(MarketScan, "ms_i_2021")
ms_s_2021 <- tbl(MarketScan, "ms_s_2021")
ms_d_2021 <- tbl(MarketScan, "ms_d_2021")
ms_o_2021 <- tbl(MarketScan, "ms_o_2021")
ms_a_2021 <- tbl(MarketScan, "ms_a_2021")
ms_t_2021 <- tbl(MarketScan, "ms_t_2021")
redbook_2021 <- tbl(MarketScan, "redbook_2021")

# Year 2022
ms_i_2022 <- tbl(MarketScan, "ms_i_2022")
ms_s_2022 <- tbl(MarketScan, "ms_s_2022")
ms_d_2022 <- tbl(MarketScan, "ms_d_2022")
ms_o_2022 <- tbl(MarketScan, "ms_o_2022")
ms_a_2022 <- tbl(MarketScan, "ms_a_2022")
ms_t_2022 <- tbl(MarketScan, "ms_t_2022")
redbook_2022 <- tbl(MarketScan, "redbook_2022")
```




Identify patients with febrile seizures
```{r}
# Codes for patients with febrile seizures
code_simple_febrile_seizures_ICD9 <- c("78031")

code_complex_febrile_seizures_ICD9 <- c("78032")

code_simple_febrile_seizures_ICD10 <- c("R5600")

code_complex_febrile_seizures_ICD10 <- c("R5601")


# Patients with febrile seizures

#################################2006#################################
febrile_seizures_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2007#################################
febrile_seizures_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2008#################################
febrile_seizures_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2009#################################
febrile_seizures_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2010#################################
febrile_seizures_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2011#################################
febrile_seizures_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2012#################################
febrile_seizures_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2013#################################
febrile_seizures_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2014#################################
febrile_seizures_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2015#################################
febrile_seizures_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9 | DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9 | DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD9 | DX1 %in% code_complex_febrile_seizures_ICD9 | DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ "simple",
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ "complex",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2016#################################
febrile_seizures_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2017#################################
febrile_seizures_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2018#################################
febrile_seizures_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2019#################################
febrile_seizures_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2020#################################
febrile_seizures_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2021#################################
febrile_seizures_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))


#################################2022#################################
febrile_seizures_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, ADMDATE) %>%
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>%
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))

febrile_seizures_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, SVCDATE) %>% 
  filter(DX1 %in% code_simple_febrile_seizures_ICD10 | DX1 %in% code_complex_febrile_seizures_ICD10) %>% 
  mutate(febrile_seizure_type = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD10 ~ "simple",
    DX1 %in% code_complex_febrile_seizures_ICD10 ~ "complex",
    TRUE ~ "no")) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>%
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>%
  select(ENROLID, SVCDATE, AGE, SEX, febrile_seizure_type) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy))




# Patients with febrile_seizures
febrile_seizures <- bind_rows(febrile_seizures_2006_i, febrile_seizures_2006_o, febrile_seizures_2006_s, febrile_seizures_2007_i, febrile_seizures_2007_o, febrile_seizures_2007_s, febrile_seizures_2008_i, febrile_seizures_2008_o, febrile_seizures_2008_s, febrile_seizures_2009_i, febrile_seizures_2009_o, febrile_seizures_2009_s, febrile_seizures_2010_i, febrile_seizures_2010_o, febrile_seizures_2010_s, febrile_seizures_2011_i, febrile_seizures_2011_o, febrile_seizures_2011_s, febrile_seizures_2012_i, febrile_seizures_2012_o, febrile_seizures_2012_s, febrile_seizures_2013_i, febrile_seizures_2013_o, febrile_seizures_2013_s, febrile_seizures_2014_i, febrile_seizures_2014_o, febrile_seizures_2014_s, febrile_seizures_2015_i, febrile_seizures_2015_o, febrile_seizures_2015_s, febrile_seizures_2016_i, febrile_seizures_2016_o, febrile_seizures_2016_s, febrile_seizures_2017_i, febrile_seizures_2017_o, febrile_seizures_2017_s, febrile_seizures_2018_i, febrile_seizures_2018_o, febrile_seizures_2018_s, febrile_seizures_2019_i, febrile_seizures_2019_o, febrile_seizures_2019_s, febrile_seizures_2020_i, febrile_seizures_2020_o, febrile_seizures_2020_s, febrile_seizures_2021_i, febrile_seizures_2021_o, febrile_seizures_2021_s, febrile_seizures_2022_i, febrile_seizures_2022_o, febrile_seizures_2022_s) %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  filter(AGE < 5) %>% 
  collect()




# First febrile seizure
first_febrile_seizure <- febrile_seizures %>% 
  distinct(ENROLID, .keep_all=TRUE) %>%  
  collect()
```




Identify pharmacy coverage period
```{r}
# Identify the period of enrollment for pharmacy benefits
##################################2006###################################
febrile_seizure_enrollment_2006 <- ms_t_2006 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2007###################################
febrile_seizure_enrollment_2007 <- ms_t_2007 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2008###################################
febrile_seizure_enrollment_2008 <- ms_t_2008 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2009###################################
febrile_seizure_enrollment_2009 <- ms_t_2009 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2010###################################
febrile_seizure_enrollment_2010 <- ms_t_2010 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2011###################################
febrile_seizure_enrollment_2011 <- ms_t_2011 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2012###################################
febrile_seizure_enrollment_2012 <- ms_t_2012 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2013###################################
febrile_seizure_enrollment_2013 <- ms_t_2013 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2014###################################
febrile_seizure_enrollment_2014 <- ms_t_2014 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2015###################################
febrile_seizure_enrollment_2015 <- ms_t_2015 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2016###################################
febrile_seizure_enrollment_2016 <- ms_t_2016 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2017###################################
febrile_seizure_enrollment_2017 <- ms_t_2017 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2018###################################
febrile_seizure_enrollment_2018 <- ms_t_2018 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2019###################################
febrile_seizure_enrollment_2019 <- ms_t_2019 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2020###################################
febrile_seizure_enrollment_2020 <- ms_t_2020 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2021###################################
febrile_seizure_enrollment_2021 <- ms_t_2021 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))


##################################2022###################################
febrile_seizure_enrollment_2022 <- ms_t_2022 %>% 
  select(ENROLID, DTSTART, DTEND, MEMDAYS, RX) %>% 
  mutate(across(c(ENROLID, MEMDAYS, RX), as.numeric)) %>%
  filter(ENROLID %in% !!first_febrile_seizure$ENROLID) %>% 
  filter(RX==1) %>% 
  collect() %>% 
  mutate(across(c(DTSTART, DTEND), mdy))




# febrile_seizure_enrollment 
febrile_seizure_enrollment <- bind_rows(febrile_seizure_enrollment_2006, febrile_seizure_enrollment_2007, febrile_seizure_enrollment_2008, febrile_seizure_enrollment_2009, febrile_seizure_enrollment_2010, febrile_seizure_enrollment_2011, febrile_seizure_enrollment_2012, febrile_seizure_enrollment_2013, febrile_seizure_enrollment_2014, febrile_seizure_enrollment_2015, febrile_seizure_enrollment_2016, febrile_seizure_enrollment_2017, febrile_seizure_enrollment_2018, febrile_seizure_enrollment_2019, febrile_seizure_enrollment_2020, febrile_seizure_enrollment_2021, febrile_seizure_enrollment_2022) %>% 
  filter(RX==1) %>% 
  left_join(first_febrile_seizure, by="ENROLID") %>% 
  arrange(ENROLID, DTSTART) %>% 
  group_by(ENROLID) %>% 
  mutate(patients_younger_than_6_months = case_when(
    ((AGE==0) & (as.numeric(dplyr::first(SVCDATE) - dplyr::first(DTSTART)) > 0) & (as.numeric(dplyr::first(SVCDATE) - dplyr::first(DTSTART)) < 180)) ~ "yes",
    TRUE ~ "no"
  )) %>%   
  filter(patients_younger_than_6_months=="no") %>% 
  filter(DTSTART >= (SVCDATE - days(31))) %>% 
  mutate(coverage_gap = as.numeric(DTSTART - lag(DTEND))) %>% 
  mutate(long_coverage_gap = case_when(
    coverage_gap > 1 ~ lag(DTEND),
    TRUE ~ NA)) %>%
  mutate(end_of_follow_up = min(max(DTEND), long_coverage_gap, na.rm=TRUE)) %>% 
  filter(DTEND <= end_of_follow_up) %>% 
  mutate(length_of_follow_up = as.numeric(end_of_follow_up - SVCDATE)) %>% 
  filter(length_of_follow_up >= 30) %>% 
  select(ENROLID, AGE, SEX, SVCDATE, end_of_follow_up, length_of_follow_up, febrile_seizure_type) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect()
```




Information on antiseizure medications
```{r}
# Extract the information from the redbook data
redbook_2006_data <- redbook_2006 %>% collect()
redbook_2007_data <- redbook_2007 %>% collect()
redbook_2008_data <- redbook_2008 %>% collect()
redbook_2009_data <- redbook_2009 %>% collect()
redbook_2010_data <- redbook_2010 %>% collect()
redbook_2011_data <- redbook_2011 %>% collect()
redbook_2012_data <- redbook_2012 %>% collect()
redbook_2013_data <- redbook_2013 %>% collect()
redbook_2014_data <- redbook_2014 %>% collect()
redbook_2015_data <- redbook_2015 %>% collect()
redbook_2016_data <- redbook_2016 %>% collect()
redbook_2017_data <- redbook_2017 %>% collect()
redbook_2018_data <- redbook_2018 %>% collect()
redbook_2019_data <- redbook_2019 %>% collect()
redbook_2020_data <- redbook_2020 %>% collect()
redbook_2021_data <- redbook_2021 %>% collect()
redbook_2022_data <- redbook_2022 %>% collect()
```




Rescue medications
```{r}
# NDCNUM codes for rectal diazepam
codes_NDCNUM_rectal_DZP_2006 <- redbook_2006_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2006 <- as.numeric(codes_NDCNUM_rectal_DZP_2006)


codes_NDCNUM_rectal_DZP_2007 <- redbook_2007_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2007 <- as.numeric(codes_NDCNUM_rectal_DZP_2007)


codes_NDCNUM_rectal_DZP_2008 <- redbook_2008_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2008 <- as.numeric(codes_NDCNUM_rectal_DZP_2008)


codes_NDCNUM_rectal_DZP_2009 <- redbook_2009_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2009 <- as.numeric(codes_NDCNUM_rectal_DZP_2009)


codes_NDCNUM_rectal_DZP_2010 <- redbook_2010_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2010 <- as.numeric(codes_NDCNUM_rectal_DZP_2010)


codes_NDCNUM_rectal_DZP_2011 <- redbook_2011_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2011 <- as.numeric(codes_NDCNUM_rectal_DZP_2011)


codes_NDCNUM_rectal_DZP_2012 <- redbook_2012_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2012 <- as.numeric(codes_NDCNUM_rectal_DZP_2012)


codes_NDCNUM_rectal_DZP_2013 <- redbook_2013_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2013 <- as.numeric(codes_NDCNUM_rectal_DZP_2013)


codes_NDCNUM_rectal_DZP_2014 <- redbook_2014_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE)
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2014 <- as.numeric(codes_NDCNUM_rectal_DZP_2014)


codes_NDCNUM_rectal_DZP_2015 <- redbook_2015_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2015 <- as.numeric(codes_NDCNUM_rectal_DZP_2015)


codes_NDCNUM_rectal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2016 <- as.numeric(codes_NDCNUM_rectal_DZP_2016)


codes_NDCNUM_rectal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2017 <- as.numeric(codes_NDCNUM_rectal_DZP_2017)


codes_NDCNUM_rectal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2018 <- as.numeric(codes_NDCNUM_rectal_DZP_2018)


codes_NDCNUM_rectal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2019 <- as.numeric(codes_NDCNUM_rectal_DZP_2019)


codes_NDCNUM_rectal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2020 <- as.numeric(codes_NDCNUM_rectal_DZP_2020)


codes_NDCNUM_rectal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2021 <- as.numeric(codes_NDCNUM_rectal_DZP_2021)


codes_NDCNUM_rectal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2022 <- as.numeric(codes_NDCNUM_rectal_DZP_2022)




# NDCNUM codes for intranasal midazolam
codes_NDCNUM_intranasal_MDZ_2006 <- redbook_2006_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2006 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2006)


codes_NDCNUM_intranasal_MDZ_2007 <- redbook_2007_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2007 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2007)


codes_NDCNUM_intranasal_MDZ_2008 <- redbook_2008_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2008 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2008)


codes_NDCNUM_intranasal_MDZ_2009 <- redbook_2009_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2009 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2009)


codes_NDCNUM_intranasal_MDZ_2010 <- redbook_2010_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2010 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2010)


codes_NDCNUM_intranasal_MDZ_2011 <- redbook_2011_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2011 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2011)


codes_NDCNUM_intranasal_MDZ_2012 <- redbook_2012_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2012 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2012)


codes_NDCNUM_intranasal_MDZ_2013 <- redbook_2013_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2013 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2013)


codes_NDCNUM_intranasal_MDZ_2014 <- redbook_2014_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2014 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2014)


codes_NDCNUM_intranasal_MDZ_2015 <- redbook_2015_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2015 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2015)


codes_NDCNUM_intranasal_MDZ_2016 <- redbook_2016_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2016 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2016)


codes_NDCNUM_intranasal_MDZ_2017 <- redbook_2017_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2017 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2017)


codes_NDCNUM_intranasal_MDZ_2018 <- redbook_2018_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2018 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2018)


codes_NDCNUM_intranasal_MDZ_2019 <- redbook_2019_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2019 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2019)


codes_NDCNUM_intranasal_MDZ_2020 <- redbook_2020_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2020 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2020)


codes_NDCNUM_intranasal_MDZ_2021 <- redbook_2021_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2021 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2021)


codes_NDCNUM_intranasal_MDZ_2022 <- redbook_2022_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2022 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2022)




# NDCNUM codes for intranasal diazepam
codes_NDCNUM_intranasal_DZP_2006 <- redbook_2006_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2006 <- as.numeric(codes_NDCNUM_intranasal_DZP_2006)


codes_NDCNUM_intranasal_DZP_2007 <- redbook_2007_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2007 <- as.numeric(codes_NDCNUM_intranasal_DZP_2007)


codes_NDCNUM_intranasal_DZP_2008 <- redbook_2008_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2008 <- as.numeric(codes_NDCNUM_intranasal_DZP_2008)


codes_NDCNUM_intranasal_DZP_2009 <- redbook_2009_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2009 <- as.numeric(codes_NDCNUM_intranasal_DZP_2009)


codes_NDCNUM_intranasal_DZP_2010 <- redbook_2010_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2010 <- as.numeric(codes_NDCNUM_intranasal_DZP_2010)


codes_NDCNUM_intranasal_DZP_2011 <- redbook_2011_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2011 <- as.numeric(codes_NDCNUM_intranasal_DZP_2011)


codes_NDCNUM_intranasal_DZP_2012 <- redbook_2012_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2012 <- as.numeric(codes_NDCNUM_intranasal_DZP_2012)


codes_NDCNUM_intranasal_DZP_2013 <- redbook_2013_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2013 <- as.numeric(codes_NDCNUM_intranasal_DZP_2013)


codes_NDCNUM_intranasal_DZP_2014 <- redbook_2014_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2014 <- as.numeric(codes_NDCNUM_intranasal_DZP_2014)


codes_NDCNUM_intranasal_DZP_2015 <- redbook_2015_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2015 <- as.numeric(codes_NDCNUM_intranasal_DZP_2015)


codes_NDCNUM_intranasal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2016 <- as.numeric(codes_NDCNUM_intranasal_DZP_2016)


codes_NDCNUM_intranasal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2017 <- as.numeric(codes_NDCNUM_intranasal_DZP_2017)


codes_NDCNUM_intranasal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2018 <- as.numeric(codes_NDCNUM_intranasal_DZP_2018)


codes_NDCNUM_intranasal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2019 <- as.numeric(codes_NDCNUM_intranasal_DZP_2019)


codes_NDCNUM_intranasal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2020 <- as.numeric(codes_NDCNUM_intranasal_DZP_2020)


codes_NDCNUM_intranasal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2021 <- as.numeric(codes_NDCNUM_intranasal_DZP_2021)


codes_NDCNUM_intranasal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2022 <- as.numeric(codes_NDCNUM_intranasal_DZP_2022)
```




Patients with febrile seizures with at least 1 month of follow-up and with at least one rescue medication prescribed
```{r}
# Rescue medications
####################################2006####################################
rescue_medication_febrile_seizure_2006 <- ms_d_2006 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2006) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2006) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2006) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2006 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2006 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2006 ~ "intranasal diazepam"))


####################################2007####################################
rescue_medication_febrile_seizure_2007 <- ms_d_2007 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2007) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2007) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2007) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2007 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2007 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2007 ~ "intranasal diazepam"))


####################################2008####################################
rescue_medication_febrile_seizure_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2008 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008 ~ "intranasal diazepam"))


####################################2008####################################
rescue_medication_febrile_seizure_2008 <- ms_d_2008 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2008 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2008 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2008 ~ "intranasal diazepam"))


####################################2009####################################
rescue_medication_febrile_seizure_2009 <- ms_d_2009 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2009) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2009) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2009) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2009 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2009 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2009 ~ "intranasal diazepam"))


####################################2010####################################
rescue_medication_febrile_seizure_2010 <- ms_d_2010 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2010) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2010) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2010) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2010 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2010 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2010 ~ "intranasal diazepam"))


####################################2011####################################
rescue_medication_febrile_seizure_2011 <- ms_d_2011 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2011) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2011) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2011) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2011 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2011 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2011 ~ "intranasal diazepam"))


####################################2012####################################
rescue_medication_febrile_seizure_2012 <- ms_d_2012 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2012) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2012) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2012) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2012 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2012 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2012 ~ "intranasal diazepam"))


####################################2013####################################
rescue_medication_febrile_seizure_2013 <- ms_d_2013 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2013) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2013) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2013) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2013 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2013 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2013 ~ "intranasal diazepam"))


####################################2014####################################
rescue_medication_febrile_seizure_2014 <- ms_d_2014 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2014) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2014) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2014) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2014 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2014 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2014 ~ "intranasal diazepam"))


####################################2015####################################
rescue_medication_febrile_seizure_2015 <- ms_d_2015 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2015) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2015) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2015) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2015 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2015 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2015 ~ "intranasal diazepam"))


####################################2016####################################
rescue_medication_febrile_seizure_2016 <- ms_d_2016 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2016 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016 ~ "intranasal diazepam"))


####################################2017####################################
rescue_medication_febrile_seizure_2017 <- ms_d_2017 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2017 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017 ~ "intranasal diazepam"))


####################################2018####################################
rescue_medication_febrile_seizure_2018 <- ms_d_2018 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2018 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018 ~ "intranasal diazepam"))


####################################2019####################################
rescue_medication_febrile_seizure_2019 <- ms_d_2019 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2019 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019 ~ "intranasal diazepam"))


####################################2020####################################
rescue_medication_febrile_seizure_2020 <- ms_d_2020 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2020 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020 ~ "intranasal diazepam"))


####################################2021####################################
rescue_medication_febrile_seizure_2021 <- ms_d_2021 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2021 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021 ~ "intranasal diazepam"))


####################################2022####################################
rescue_medication_febrile_seizure_2022 <- ms_d_2022 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2022 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022 ~ "intranasal diazepam"))




# Rescue medication
rescue_medication_febrile_seizure <- bind_rows(rescue_medication_febrile_seizure_2006, rescue_medication_febrile_seizure_2007, rescue_medication_febrile_seizure_2008, rescue_medication_febrile_seizure_2009, rescue_medication_febrile_seizure_2010, rescue_medication_febrile_seizure_2011, rescue_medication_febrile_seizure_2012, rescue_medication_febrile_seizure_2013, rescue_medication_febrile_seizure_2014, rescue_medication_febrile_seizure_2015, rescue_medication_febrile_seizure_2016, rescue_medication_febrile_seizure_2017, rescue_medication_febrile_seizure_2018, rescue_medication_febrile_seizure_2019, rescue_medication_febrile_seizure_2020, rescue_medication_febrile_seizure_2021, rescue_medication_febrile_seizure_2022) %>% 
  mutate(rescue_medication = factor(rescue_medication)) %>%    
  mutate(GENIND = factor(GENIND)) %>% 
  mutate(RXMR = factor(RXMR)) %>%           
  arrange(ENROLID, rescue_medication_prescription_date) %>% 
  distinct(ENROLID, rescue_medication_prescription_date, .keep_all=TRUE) %>% 
  mutate(year_rescue_medication=year(rescue_medication_prescription_date)) %>% 
  select(ENROLID, rescue_medication_prescription_date, GENIND, METQTY, rescue_medication, year_rescue_medication) %>% 
  collect()
```




Identify patients with a code for epilepsy
```{r}
# Codes for patients with epilepsy
codes_epilepsy_ICD9 <- c("345", "3450", "34500", "34501", "3451", "34510", "34511", "3454", "34540", "34541", "3455", "34550", "34551", "3456", "34560", "34561", "3457", "34570", "34571", "3458", "34580", "34581", "3459", "34590", "34591")

codes_epilepsy_ICD10 <- c("G40", "G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219", "G403", "G4030", "G40301", "G40309", "G4031", "G40311", "G40319", "G40A", "G40A0", "G40A01", "G40A09", "G40A1", "G40A11", "G40A19", "G40B", "G40B0", "G40B01", "G40B09", "G40B1", "G40B11", "G40B19", "G404", "G4040", "G40401", "G40409", "G4041", "G40411", "G40419", "G408", "G4080", "G40801", "G40802", "G40803", "G40804", "G4081", "G40811", "G40812", "G40813", "G40814", "G4082", "G40821", "G40822", "G40823", "G40824", "G4083", "G40833", "G40834", "G409", "G4090", "G40901", "G40909", "G4091", "G40911", "G40919")


# Patients with epilepsy

#################################2006#################################
epilepsy_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2007#################################
epilepsy_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2008#################################
epilepsy_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2009#################################
epilepsy_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2010#################################
epilepsy_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2011#################################
epilepsy_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2012#################################
epilepsy_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2013#################################
epilepsy_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2014#################################
epilepsy_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2015#################################
epilepsy_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                      DX3 %in% codes_epilepsy_ICD9 | DX4 %in% codes_epilepsy_ICD9 |
                                      DX5 %in% codes_epilepsy_ICD9 | DX6 %in% codes_epilepsy_ICD9 |
                                      DX7 %in% codes_epilepsy_ICD9 | DX8 %in% codes_epilepsy_ICD9 |
                                      DX9 %in% codes_epilepsy_ICD9 | DX10 %in% codes_epilepsy_ICD9 |
                                      DX11%in% codes_epilepsy_ICD9 | DX12 %in% codes_epilepsy_ICD9 |
                                      DX13 %in% codes_epilepsy_ICD9 | DX14 %in% codes_epilepsy_ICD9 |
                                      DX15 %in% codes_epilepsy_ICD9 |
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD9 | DX2 %in% codes_epilepsy_ICD9 |
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2016#################################
epilepsy_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2017#################################
epilepsy_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2018#################################
epilepsy_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2019#################################
epilepsy_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2020#################################
epilepsy_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2021#################################
epilepsy_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


#################################2022#################################
epilepsy_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% filter(
                                      DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
                                      DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
                                      DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
                                      DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
                                      DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
                                      DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
                                      DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
                                      DX15 %in% codes_epilepsy_ICD10
                                      ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
                                      distinct(ENROLID, SVCDATE) %>% 
                                      collect() %>% 
                                      mutate(across(SVCDATE, mdy))

epilepsy_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))

epilepsy_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% filter(
                                     DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10
                                     ) %>% mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                     filter(ENROLID>0) %>% 
                                     distinct(ENROLID, SVCDATE) %>% 
                                     collect() %>% 
                                     mutate(across(SVCDATE, mdy))


# Patients with a code for epilepsy
epilepsy <- bind_rows(epilepsy_2006_i, epilepsy_2006_o, epilepsy_2006_s, epilepsy_2007_i, epilepsy_2007_o, epilepsy_2007_s, epilepsy_2008_i, epilepsy_2008_o, epilepsy_2008_s, epilepsy_2009_i, epilepsy_2009_o, epilepsy_2009_s, epilepsy_2010_i, epilepsy_2010_o, epilepsy_2010_s, epilepsy_2011_i, epilepsy_2011_o, epilepsy_2011_s, epilepsy_2012_i, epilepsy_2012_o, epilepsy_2012_s, epilepsy_2013_i, epilepsy_2013_o, epilepsy_2013_s, epilepsy_2014_i, epilepsy_2014_o, epilepsy_2014_s, epilepsy_2015_i, epilepsy_2015_o, epilepsy_2015_s, epilepsy_2016_i, epilepsy_2016_o, epilepsy_2016_s, epilepsy_2017_i, epilepsy_2017_o, epilepsy_2017_s, epilepsy_2018_i, epilepsy_2018_o, epilepsy_2018_s, epilepsy_2019_i, epilepsy_2019_o, epilepsy_2019_s, epilepsy_2020_i, epilepsy_2020_o, epilepsy_2020_s, epilepsy_2021_i, epilepsy_2021_o, epilepsy_2021_s, epilepsy_2022_i, epilepsy_2022_o, epilepsy_2022_s) %>% 
  distinct(ENROLID, SVCDATE) %>% 
  group_by(ENROLID) %>% 
  filter(SVCDATE == min(SVCDATE)) %>% 
  rename(first_code_epilepsy = SVCDATE) %>% 
  collect()
```




Determination of inpatient visits and emergency visits
```{r}
# Resource utilization
revenue_codes_EDvisits <- c("0450", "0451", "0452", "0456", "0459", "0981")
place_of_service_codes_EDvisits <- c("20", "23", "41", "42")
CPT_codes_EDvisits <- c("99281", "99282", "99283", "99284", "99285")
service_subcategory_codes_EDvisits <- c("10120", "10220", "10320", "10420", "10520", "12220", "20120", "20220", "21120", "21220", "22120", "22320")
PROCGRP_codes_EDvisits <- c("111", "114")

revenue_codes_inpatient <- c("0100", "0101", "0110", "0111", "0112", "0113", "0114", "0115", "0116", "0117", "0118", "0119", "0120", "0121", "0122", "0123", "0124", "0125", "0126", "0127", "0128", "0129", "0130", "0131", "0132", "0133", "0134", "0135", "0136", "0137", "0138", "0139", "0140", "0141", "0142", "0143", "0144", "0145", "0146", "0147", "0148", "0149", "0150", "0151", "0152", "0153", "0154", "0155", "0156", "0157", "0158", "0159", "0160", "0161", "0162", "0164", "0166", "0167", "0168", "0169", "0170", "0171", "0172", "0173", "0174", "0175", "0179", "0180", "0182", "0183", "0184", "0185", "0189", "0190", "0191", "0192", "0193", "0194", "0199", "0200", "0201", "0202", "0203", "0204", "0206", "0207", "0208", "0209", "0210", "0211", "0212", "0213", "0214", "0219", "0720", "0721", "0722", "0723", "0724", "0729", "0760", "0761", "0762", "0769", "0800", "0801", "0802", "0803", "0804", "0809")
place_of_service_codes_inpatient <- c("21", "27", "28")
CPT_codes_inpatient <- c("99217", "99218", "99219", "99220", "99224", "99225", "99226", "99234", "99235", "99236")




# Inpatient and emergency visits 
#################################2006#################################
IP_ED_2006_i <- ms_i_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2006_o <- ms_o_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2006_s <- ms_s_2006 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2007#################################
IP_ED_2007_i <- ms_i_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2007_o <- ms_o_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2007_s <- ms_s_2007 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2008#################################
IP_ED_2008_i <- ms_i_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2008_o <- ms_o_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2008_s <- ms_s_2008 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2009#################################
IP_ED_2009_i <- ms_i_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2009_o <- ms_o_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2009_s <- ms_s_2009 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2010#################################
IP_ED_2010_i <- ms_i_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2010_o <- ms_o_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2010_s <- ms_s_2010 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2011#################################
IP_ED_2011_i <- ms_i_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2011_o <- ms_o_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2011_s <- ms_s_2011 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2012#################################
IP_ED_2012_i <- ms_i_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2012_o <- ms_o_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2012_s <- ms_s_2012 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2013#################################
IP_ED_2013_i <- ms_i_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2013_o <- ms_o_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2013_s <- ms_s_2013 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2014#################################
IP_ED_2014_i <- ms_i_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2014_o <- ms_o_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2014_s <- ms_s_2014 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
    DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
    DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2015#################################
IP_ED_2015_i <- ms_i_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2015_o <- ms_o_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2015_s <- ms_s_2015 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD9 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2016#################################
IP_ED_2016_i <- ms_i_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2016_o <- ms_o_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2016_s <- ms_s_2016 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2017#################################
IP_ED_2017_i <- ms_i_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2017_o <- ms_o_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2017_s <- ms_s_2017 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2018#################################
IP_ED_2018_i <- ms_i_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2018_o <- ms_o_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2018_s <- ms_s_2018 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2019#################################
IP_ED_2019_i <- ms_i_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2019_o <- ms_o_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2019_s <- ms_s_2019 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2020#################################
IP_ED_2020_i <- ms_i_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2020_o <- ms_o_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2020_s <- ms_s_2020 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2021#################################
IP_ED_2021_i <- ms_i_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2021_o <- ms_o_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2021_s <- ms_s_2021 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)


#################################2022#################################
IP_ED_2022_i <- ms_i_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9, DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%  
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  mutate(SVCDATE=ADMDATE) %>%
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type="inpatient") %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
  TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2022_o <- ms_o_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PROC1, STDPLAC, REVCODE, SVCSCAT, PROCGRP) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type=case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",  
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    PROCGRP %in% PROCGRP_codes_EDvisits ~ "emergency",
    REVCODE %in% revenue_codes_inpatient ~ "inpatient",
    STDPLAC %in% place_of_service_codes_inpatient ~ "inpatient",
    PROC1 %in% CPT_codes_inpatient ~ "inpatient",
    TRUE ~ "outpatient")
    ) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)

IP_ED_2022_s <- ms_s_2022 %>% select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE, PPROC, PROC1, STDPLAC, REVCODE, SVCSCAT) %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>% 
  mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
  filter(ENROLID>0) %>% 
  distinct(ENROLID, SVCDATE, .keep_all=TRUE) %>% 
  mutate(type = case_when(
    REVCODE %in% revenue_codes_EDvisits ~ "emergency",
    STDPLAC %in% place_of_service_codes_EDvisits ~ "emergency",
    PPROC %in% CPT_codes_EDvisits ~ "emergency", 
    PROC1 %in% CPT_codes_EDvisits ~ "emergency",
    SVCSCAT %in% service_subcategory_codes_EDvisits ~ "emergency",
    TRUE ~ "inpatient")) %>% 
  mutate(febrile_seizure_encounter = case_when(
  DX1 %in% code_simple_febrile_seizures_ICD10 ~ 1,
  DX1 %in% code_complex_febrile_seizures_ICD10 ~ 1,
    TRUE ~ 0)) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, SVCDATE, type, febrile_seizure_encounter)




# Patients with inpatient or emergency events
IP_ED <- bind_rows(IP_ED_2006_i, IP_ED_2006_o, IP_ED_2006_s, IP_ED_2007_i, IP_ED_2007_o, IP_ED_2007_s, IP_ED_2008_i, IP_ED_2008_o, IP_ED_2008_s, IP_ED_2009_i, IP_ED_2009_o, IP_ED_2009_s, IP_ED_2010_i, IP_ED_2010_o, IP_ED_2010_s, IP_ED_2011_i, IP_ED_2011_o, IP_ED_2011_s, IP_ED_2012_i, IP_ED_2012_o, IP_ED_2012_s, IP_ED_2013_i, IP_ED_2013_o, IP_ED_2013_s, IP_ED_2014_i, IP_ED_2014_o, IP_ED_2014_s, IP_ED_2015_i, IP_ED_2015_o, IP_ED_2015_s, IP_ED_2016_i, IP_ED_2016_o, IP_ED_2016_s, IP_ED_2017_i, IP_ED_2017_o, IP_ED_2017_s, IP_ED_2018_i, IP_ED_2018_o, IP_ED_2018_s, IP_ED_2019_i, IP_ED_2019_o, IP_ED_2019_s, IP_ED_2020_i, IP_ED_2020_o, IP_ED_2020_s, IP_ED_2021_i, IP_ED_2021_o, IP_ED_2021_s, IP_ED_2022_i, IP_ED_2022_o, IP_ED_2022_s) %>% 
  mutate(type = factor(type)) %>% 
  rename(encounter_date = SVCDATE) %>% 
  distinct(ENROLID, encounter_date, type, .keep_all=TRUE) %>% 
  filter(febrile_seizure_encounter == 1) %>% 
  select(ENROLID, encounter_date, type) %>% 
  collect()
```




Extract information for demographics
```{r}
# Extract information from demographics 
#################################2006#################################
demographics_2006 <- ms_t_2006 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2007#################################
demographics_2007 <- ms_t_2007 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2008#################################
demographics_2008 <- ms_t_2008 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2009#################################
demographics_2009 <- ms_t_2009 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2010#################################
demographics_2010 <- ms_t_2010 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2011#################################
demographics_2011 <- ms_t_2011 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2012#################################
demographics_2012 <- ms_t_2012 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2013#################################
demographics_2013 <- ms_t_2013 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2014#################################
demographics_2014 <- ms_t_2014 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2015#################################
demographics_2015 <- ms_t_2015 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2016#################################
demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!febrile_seizure_enrollment$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Add demographic data to the database
demographics <- bind_rows(demographics_2006, demographics_2007, demographics_2008, demographics_2009, demographics_2010, demographics_2011, demographics_2012, demographics_2013, demographics_2014, demographics_2015, demographics_2016, demographics_2017, demographics_2018, demographics_2019, demographics_2020, demographics_2021, demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Febrile seizure data
```{r}
# Merge databases to have patients with febrile seizure with and without rescue medication
febrile_seizure_data <- febrile_seizure_enrollment %>% 
  select(ENROLID, SVCDATE, end_of_follow_up, length_of_follow_up) %>% 
  rename(beginning_of_follow_up = SVCDATE) %>% 
  left_join(febrile_seizures, by="ENROLID") %>% 
  filter((SVCDATE >= beginning_of_follow_up) & (SVCDATE <= end_of_follow_up)) %>% 
  group_by(ENROLID) %>% 
  mutate(age_first_febrile_seizure = min(AGE)) %>% 
  mutate(febrile_seizure_order = row_number()) %>% 
  mutate(number_febrile_seizures = n()) %>% 
  ungroup() %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, febrile_seizure_order, SVCDATE, febrile_seizure_type) %>% 
  rename(date = SVCDATE) %>% 
  rename(type = febrile_seizure_type) %>% 
  filter(febrile_seizure_order <= 5) %>% 
  pivot_wider(names_prefix = "febrile_seizure_", names_from = febrile_seizure_order, values_from = c(date, type)) %>% 
  left_join(demographics, by="ENROLID") %>% 
  mutate(rural = as.factor(case_when(
  MSA == 0 ~ "yes",
  TRUE ~ "no"))) %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, rural, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, starts_with("date_febrile_seizure_"), starts_with("type_febrile_seizure_")) %>% 
  left_join(rescue_medication_febrile_seizure, by="ENROLID") %>% 
  group_by(ENROLID) %>% 
  mutate(rescue_medication = case_when(
    is.na(rescue_medication) ~ "no",
    ((rescue_medication_prescription_date <= beginning_of_follow_up) & (rescue_medication_prescription_date >= end_of_follow_up)) ~ "no",
    TRUE ~ rescue_medication)) %>%   
  distinct(ENROLID, rescue_medication, rescue_medication_prescription_date, .keep_all=TRUE) %>% 
  mutate(rescue_medication_order = row_number()) %>% 
  mutate(number_rescue_medications = case_when(
    rescue_medication == "no" ~ 0,
    TRUE ~ n())) %>% 
  ungroup() %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, rural, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, starts_with("date_febrile_seizure_"), starts_with("type_febrile_seizure_"), rescue_medication_prescription_date, rescue_medication, rescue_medication_order, number_rescue_medications) %>% 
  filter(rescue_medication_order <= 5) %>% 
  rename(date = rescue_medication_prescription_date) %>% 
  rename(type = rescue_medication) %>% 
  pivot_wider(names_prefix = "rescue_medication_", names_from = rescue_medication_order, values_from = c(date, type)) %>% 
  left_join(epilepsy, by="ENROLID") %>% 
  group_by(ENROLID) %>% 
  mutate(first_code_epilepsy = case_when(
    (first_code_epilepsy <= end_of_follow_up) ~ first_code_epilepsy,
    TRUE ~ NA)) %>% 
  filter(is.na(first_code_epilepsy) | (first_code_epilepsy > beginning_of_follow_up)) %>% 
  mutate(eventual_epilepsy = case_when(
  is.na(first_code_epilepsy) ~ "no",
  TRUE ~ "yes")) %>% 
  mutate(time_to_epilepsy = first_code_epilepsy - date_febrile_seizure_1) %>% 
  mutate(rescue_after_epilepsy_yes_no = case_when(
  (eventual_epilepsy=="yes" & (date_rescue_medication_1 > first_code_epilepsy)) ~ "yes",
  TRUE ~ "no")) %>% 
  left_join(IP_ED, by="ENROLID") %>% 
  filter(is.na(encounter_date) | ((encounter_date >= beginning_of_follow_up) & (encounter_date <= end_of_follow_up))) %>% 
  group_by(ENROLID) %>% 
  mutate(encounter_order = row_number()) %>% 
  mutate(number_encounters = n()) %>% 
  ungroup() %>% 
  mutate(number_encounters = case_when(
    is.na(encounter_date) ~ 0,
    TRUE ~ number_encounters)) %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, rural, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, starts_with("date_febrile_seizure_"), starts_with("type_febrile_seizure_"), number_rescue_medications, starts_with("date_rescue_medication_"), starts_with("type_rescue_medication_"), first_code_epilepsy, eventual_epilepsy, time_to_epilepsy, rescue_after_epilepsy_yes_no, encounter_date, type, encounter_order, number_encounters) %>% 
  rename(date = encounter_date) %>% 
  filter(encounter_order <= 5) %>% 
  pivot_wider(names_prefix = "febrile_seizure_encounter_", names_from = encounter_order, values_from = c(date, type)) %>% 
  left_join(IP_ED[IP_ED$type=="emergency", ], by="ENROLID") %>% 
  rename(emergency_encounter_date = encounter_date) %>% 
  filter(is.na(emergency_encounter_date) | ((emergency_encounter_date >= beginning_of_follow_up) & (emergency_encounter_date <= end_of_follow_up))) %>% 
  group_by(ENROLID) %>% 
  mutate(emergency_encounter_order = row_number()) %>% 
  mutate(number_emergency_encounters = n()) %>% 
  ungroup() %>% 
  mutate(number_emergency_encounters = case_when(
    is.na(emergency_encounter_date) ~ 0,
    TRUE ~ number_emergency_encounters)) %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, rural, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, starts_with("date_febrile_seizure_"), starts_with("type_febrile_seizure_"), number_rescue_medications, starts_with("date_rescue_medication_"), starts_with("type_rescue_medication_"), first_code_epilepsy, eventual_epilepsy, time_to_epilepsy, rescue_after_epilepsy_yes_no, number_encounters, starts_with("date_febrile_seizure_encounter_"), starts_with("type_febrile_seizure_encounter_"), emergency_encounter_order, emergency_encounter_date, number_emergency_encounters) %>% 
  rename(date = emergency_encounter_date) %>% 
  filter(emergency_encounter_order <= 5) %>% 
  pivot_wider(names_prefix = "febrile_seizure_emergency_encounter_", names_from = emergency_encounter_order, values_from = date) %>% 
  left_join(IP_ED[IP_ED$type=="inpatient", ], by="ENROLID") %>% 
  rename(inpatient_encounter_date = encounter_date) %>% 
  filter(is.na(inpatient_encounter_date) | ((inpatient_encounter_date >= beginning_of_follow_up) & (inpatient_encounter_date <= end_of_follow_up))) %>% 
  group_by(ENROLID) %>% 
  mutate(inpatient_encounter_order = row_number()) %>% 
  mutate(number_inpatient_encounters = n()) %>% 
  ungroup() %>% 
  mutate(number_inpatient_encounters = case_when(
    is.na(inpatient_encounter_date) ~ 0,
    TRUE ~ number_inpatient_encounters)) %>% 
  select(ENROLID, age_first_febrile_seizure, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, rural, beginning_of_follow_up, end_of_follow_up, length_of_follow_up, number_febrile_seizures, starts_with("date_febrile_seizure_"), starts_with("type_febrile_seizure_"), number_rescue_medications, starts_with("date_rescue_medication_"), starts_with("type_rescue_medication_"), first_code_epilepsy, eventual_epilepsy, time_to_epilepsy, rescue_after_epilepsy_yes_no, number_encounters, starts_with("date_febrile_seizure_encounter_"), starts_with("type_febrile_seizure_encounter_"), number_emergency_encounters, starts_with("febrile_seizure_emergency_encounter_"), inpatient_encounter_order, inpatient_encounter_date, number_inpatient_encounters) %>% 
  rename(date = inpatient_encounter_date) %>% 
  filter(inpatient_encounter_order <= 5) %>% 
  pivot_wider(names_prefix = "febrile_seizure_inpatient_encounter_", names_from = inpatient_encounter_order, values_from = date) %>% 
  mutate(rescue_medication_yes_no = case_when(
    number_rescue_medications == 0 ~ "no",
    TRUE ~ "yes")) %>% 
  mutate(time_to_first_rescue_medication = case_when(
  rescue_medication_yes_no == "yes" ~ as.numeric(date_rescue_medication_1 - date_febrile_seizure_1),
  TRUE ~ NA)) %>%
  filter(is.na(time_to_first_rescue_medication) | time_to_first_rescue_medication >= 0) %>% 
  collect()
```








## 3. Demographic and clinical features




Demographics
```{r}
# Total patients
total_patients <- febrile_seizure_data %>% 
  distinct(ENROLID) %>% 
  nrow()
total_patients

CrossTable(febrile_seizure_data$rescue_medication_yes_no)




# Age
age <- febrile_seizure_data %>% 
  summarize(
    median_age = median(age_first_febrile_seizure),
    p25_age = quantile(age_first_febrile_seizure, 0.25),
    p75_age = quantile(age_first_febrile_seizure, 0.75),
    mean_age = mean(age_first_febrile_seizure),
    SD_age = sd(age_first_febrile_seizure)
  ) %>% 
  collect()
age

age_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_age = median(age_first_febrile_seizure),
    p25_age = quantile(age_first_febrile_seizure, 0.25),
    p75_age = quantile(age_first_febrile_seizure, 0.75),
    mean_age = mean(age_first_febrile_seizure),
    SD_age = sd(age_first_febrile_seizure)
  ) %>% 
  collect()
age_with_rescue_BZD

age_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_age = median(age_first_febrile_seizure),
    p25_age = quantile(age_first_febrile_seizure, 0.25),
    p75_age = quantile(age_first_febrile_seizure, 0.75),
    mean_age = mean(age_first_febrile_seizure),
    SD_age = sd(age_first_febrile_seizure)
  ) %>% 
  collect()
age_without_rescue_BZD




# Length of follow-up
length_of_follow_up_all <- febrile_seizure_data %>% 
  summarize(
    median_length_of_follow_up = median(length_of_follow_up)/365.24219,
    p25_length_of_follow_up = quantile(length_of_follow_up, 0.25)/365.24219,
    p75_length_of_follow_up = quantile(length_of_follow_up, 0.75)/365.24219,
    mean_length_of_follow_up = mean(length_of_follow_up)/365.24219,
    SD_length_of_follow_up = sd(length_of_follow_up)/365.24219
  ) %>% 
  collect()
length_of_follow_up_all

length_of_follow_up_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_length_of_follow_up = median(length_of_follow_up)/365.24219,
    p25_length_of_follow_up = quantile(length_of_follow_up, 0.25)/365.24219,
    p75_length_of_follow_up = quantile(length_of_follow_up, 0.75)/365.24219,
    mean_length_of_follow_up = mean(length_of_follow_up)/365.24219,
    SD_length_of_follow_up = sd(length_of_follow_up)/365.24219
  ) %>% 
  collect()
length_of_follow_up_with_rescue_BZD

length_of_follow_up_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_length_of_follow_up = median(length_of_follow_up)/365.24219,
    p25_length_of_follow_up = quantile(length_of_follow_up, 0.25)/365.24219,
    p75_length_of_follow_up = quantile(length_of_follow_up, 0.75)/365.24219,
    mean_length_of_follow_up = mean(length_of_follow_up)/365.24219,
    SD_length_of_follow_up = sd(length_of_follow_up)/365.24219
  ) %>% 
  collect()
length_of_follow_up_without_rescue_BZD




# Sex
sex_all <- febrile_seizure_data %>% 
  reframe(
  sex = CrossTable(SEX)
)

sex_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  sex = CrossTable(SEX)
)

sex_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  sex = CrossTable(SEX)
)




# Type of initial febrile seizure
initial_febrile_seizure_type_all <- febrile_seizure_data %>% 
  reframe(
  initial_febrile_seizure_type = CrossTable(type_febrile_seizure_1)
)

initial_febrile_seizure_type_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  initial_febrile_seizure_type = CrossTable(type_febrile_seizure_1)
)

initial_febrile_seizure_type_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  initial_febrile_seizure_type = CrossTable(type_febrile_seizure_1)
)




# Number of febrile seizures during follow-up
number_febrile_seizures_all <- febrile_seizure_data %>% 
  summarize(
    median_number = median(number_febrile_seizures),
    p25_number = quantile(number_febrile_seizures, 0.25),
    p75_number = quantile(number_febrile_seizures, 0.75),
    mean_number = mean(number_febrile_seizures),
    SD_number = sd(number_febrile_seizures)
  ) %>% 
  collect()
number_febrile_seizures_all

number_febrile_seizures_with_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_number = median(number_febrile_seizures),
    p25_number = quantile(number_febrile_seizures, 0.25),
    p75_number = quantile(number_febrile_seizures, 0.75),
    mean_number = mean(number_febrile_seizures),
    SD_number = sd(number_febrile_seizures)
  ) %>% 
  collect()
number_febrile_seizures_with_rescue_BZD

number_febrile_seizures_without_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_number = median(number_febrile_seizures),
    p25_number = quantile(number_febrile_seizures, 0.25),
    p75_number = quantile(number_febrile_seizures, 0.75),
    mean_number = mean(number_febrile_seizures),
    SD_number = sd(number_febrile_seizures)
  ) %>% 
  collect()
number_febrile_seizures_without_rescue_BZD




# Type of initial rescue medication
initial_rescue_BZD_all <- febrile_seizure_data %>% 
  reframe(
  initial_rescue_BZD = CrossTable(type_rescue_medication_1)
)

initial_rescue_BZD_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  initial_rescue_BZD = CrossTable(type_rescue_medication_1)
)

initial_rescue_BZD_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  initial_rescue_BZD = table(type_rescue_medication_1)
)
initial_rescue_BZD_without_rescue_BZD




# Number of rescue medications during follow-up
number_rescue_medications_all <- febrile_seizure_data %>% 
  summarize(
    median_number = median(number_rescue_medications),
    p25_number = quantile(number_rescue_medications, 0.25),
    p75_number = quantile(number_rescue_medications, 0.75),
    mean_number = mean(number_rescue_medications),
    SD_number = sd(number_rescue_medications)
  ) %>% 
  collect()
number_rescue_medications_all

number_rescue_medications_with_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_number = median(number_rescue_medications),
    p25_number = quantile(number_rescue_medications, 0.25),
    p75_number = quantile(number_rescue_medications, 0.75),
    mean_number = mean(number_rescue_medications),
    SD_number = sd(number_rescue_medications)
  ) %>% 
  collect()
number_rescue_medications_with_rescue_BZD

number_rescue_medications_without_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_number = median(number_rescue_medications),
    p25_number = quantile(number_rescue_medications, 0.25),
    p75_number = quantile(number_rescue_medications, 0.75),
    mean_number = mean(number_rescue_medications),
    SD_number = sd(number_rescue_medications)
  ) %>% 
  collect()
number_rescue_medications_without_rescue_BZD




# Number of encounters during follow-up
number_encounters_all <- febrile_seizure_data %>% 
  summarize(
    median_number = median(number_encounters),
    p25_number = quantile(number_encounters, 0.25),
    p75_number = quantile(number_encounters, 0.75),
    mean_number = mean(number_encounters),
    SD_number = sd(number_encounters)
  ) %>% 
  collect()
number_encounters_all

number_encounters_with_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_number = median(number_encounters),
    p25_number = quantile(number_encounters, 0.25),
    p75_number = quantile(number_encounters, 0.75),
    mean_number = mean(number_encounters),
    SD_number = sd(number_encounters)
  ) %>% 
  collect()
number_encounters_with_rescue_BZD

number_encounters_without_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_number = median(number_encounters),
    p25_number = quantile(number_encounters, 0.25),
    p75_number = quantile(number_encounters, 0.75),
    mean_number = mean(number_encounters),
    SD_number = sd(number_encounters)
  ) %>% 
  collect()
number_encounters_without_rescue_BZD




# Number of emergency department encounters during follow-up
number_emergency_encounters_all <- febrile_seizure_data %>% 
  summarize(
    median_number = median(number_emergency_encounters),
    p25_number = quantile(number_emergency_encounters, 0.25),
    p75_number = quantile(number_emergency_encounters, 0.75),
    mean_number = mean(number_emergency_encounters),
    SD_number = sd(number_emergency_encounters)
  ) %>% 
  collect()
number_emergency_encounters_all

number_emergency_encounters_with_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_number = median(number_emergency_encounters),
    p25_number = quantile(number_emergency_encounters, 0.25),
    p75_number = quantile(number_emergency_encounters, 0.75),
    mean_number = mean(number_emergency_encounters),
    SD_number = sd(number_emergency_encounters)
  ) %>% 
  collect()
number_emergency_encounters_with_rescue_BZD

number_emergency_encounters_without_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_number = median(number_emergency_encounters),
    p25_number = quantile(number_emergency_encounters, 0.25),
    p75_number = quantile(number_emergency_encounters, 0.75),
    mean_number = mean(number_emergency_encounters),
    SD_number = sd(number_emergency_encounters)
  ) %>% 
  collect()
number_emergency_encounters_without_rescue_BZD




# Number of inpatient encounters during follow-up
number_inpatient_encounters_all <- febrile_seizure_data %>% 
  summarize(
    median_number = median(number_inpatient_encounters),
    p25_number = quantile(number_inpatient_encounters, 0.25),
    p75_number = quantile(number_inpatient_encounters, 0.75),
    mean_number = mean(number_inpatient_encounters),
    SD_number = sd(number_inpatient_encounters)
  ) %>% 
  collect()
number_inpatient_encounters_all

number_inpatient_encounters_with_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="yes") %>% 
  summarize(
    median_number = median(number_inpatient_encounters),
    p25_number = quantile(number_inpatient_encounters, 0.25),
    p75_number = quantile(number_inpatient_encounters, 0.75),
    mean_number = mean(number_inpatient_encounters),
    SD_number = sd(number_inpatient_encounters)
  ) %>% 
  collect()
number_inpatient_encounters_with_rescue_BZD

number_inpatient_encounters_without_rescue_BZD <- febrile_seizure_data %>%   
  filter(rescue_medication_yes_no=="no") %>% 
  summarize(
    median_number = median(number_inpatient_encounters),
    p25_number = quantile(number_inpatient_encounters, 0.25),
    p75_number = quantile(number_inpatient_encounters, 0.75),
    mean_number = mean(number_inpatient_encounters),
    SD_number = sd(number_inpatient_encounters)
  ) %>% 
  collect()
number_inpatient_encounters_without_rescue_BZD




# Type of initial encounter
initial_encounter_type_all <- febrile_seizure_data %>% 
  reframe(
  initial_encounter_type = CrossTable(type_febrile_seizure_encounter_1)
)

initial_encounter_type_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  initial_encounter_type = CrossTable(type_febrile_seizure_encounter_1)
)

initial_encounter_type_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  initial_encounter_type = CrossTable(type_febrile_seizure_encounter_1)
)




# Eventual diagnosis of epilepsy
eventual_epilepsy_all <- febrile_seizure_data %>% 
  reframe(
  eventual_epilepsy = CrossTable(eventual_epilepsy)
)

eventual_epilepsy_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  eventual_epilepsy = CrossTable(eventual_epilepsy)
)

eventual_epilepsy_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  eventual_epilepsy = CrossTable(eventual_epilepsy)
)




# Rescue medication only after epilepsy
rescue_after_epilepsy_all <- febrile_seizure_data %>% 
  reframe(
  rescue_after_epilepsy = CrossTable(rescue_after_epilepsy_yes_no)
)

rescue_after_epilepsy_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  rescue_after_epilepsy = CrossTable(rescue_after_epilepsy_yes_no)
)

rescue_after_epilepsy_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  rescue_after_epilepsy = table(rescue_after_epilepsy_yes_no)
)
rescue_after_epilepsy_without_rescue_BZD




# Year
year_first_febrile_seizure_all <- febrile_seizure_data %>% 
  mutate(year_first_febrile_seizure = case_when(
  (year(beginning_of_follow_up) %in% 2006:2011) ~ "2006-2011",
  (year(beginning_of_follow_up) %in% 2012:2017) ~ "2012-2017",
  (year(beginning_of_follow_up) %in% 2018:2022) ~ "2018-2022")) %>% 
  reframe(
  year_first_febrile_seizure = CrossTable(year_first_febrile_seizure)
)

year_first_febrile_seizure_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  mutate(year_first_febrile_seizure = case_when(
  (year(beginning_of_follow_up) %in% 2006:2011) ~ "2006-2011",
  (year(beginning_of_follow_up) %in% 2012:2017) ~ "2012-2017",
  (year(beginning_of_follow_up) %in% 2018:2022) ~ "2018-2022")) %>% 
  reframe(
  year_first_febrile_seizure = CrossTable(year_first_febrile_seizure)
)

year_first_febrile_seizure_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  mutate(year_first_febrile_seizure = case_when(
  (year(beginning_of_follow_up) %in% 2006:2011) ~ "2006-2011",
  (year(beginning_of_follow_up) %in% 2012:2017) ~ "2012-2017",
  (year(beginning_of_follow_up) %in% 2018:2022) ~ "2018-2022")) %>% 
  reframe(
  year_first_febrile_seizure = CrossTable(year_first_febrile_seizure)
)




# Rural
rural_all <- febrile_seizure_data %>% 
  reframe(
  rural = CrossTable(rural)
)

rural_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  rural = CrossTable(rural)
)

rural_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  rural = CrossTable(rural)
)




# Region
region_all <- febrile_seizure_data %>% 
  reframe(
  region = CrossTable(REGION)
)

region_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  region = CrossTable(REGION)
)

region_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  region = CrossTable(REGION)
)




# Employment status
employment_status_all <- febrile_seizure_data %>% 
  reframe(
  employment_status = CrossTable(EESTATU)
)

employment_status_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  employment_status = CrossTable(EESTATU)
)

employment_status_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  employment_status = CrossTable(EESTATU)
)




# Employment class
employment_class_all <- febrile_seizure_data %>% 
  reframe(
  employment_class = CrossTable(EECLASS)
)

employment_class_with_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="yes") %>% 
  reframe(
  employment_class = CrossTable(EECLASS)
)

employment_class_without_rescue_BZD <- febrile_seizure_data %>% 
  filter(rescue_medication_yes_no=="no") %>% 
  reframe(
  employment_class = CrossTable(EECLASS)
)
```








## 4. Main clinical outocomes




Database for regression
```{r}
# Modify database for regression
febrile_seizure_data_for_regression <- febrile_seizure_data %>% 
  mutate(rescue_medication_yes_no = as.factor(rescue_medication_yes_no)) %>% 
  mutate(female = as.factor(case_when(
  SEX == 2 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(type_febrile_seizure_1 = as.factor(type_febrile_seizure_1)) %>% 
  mutate(type_febrile_seizure_encounter_1 = as.factor(type_febrile_seizure_encounter_1)) %>% 
  mutate(eventual_epilepsy = as.factor(eventual_epilepsy)) %>% 
  mutate(year_first_febrile_seizure = case_when(
  (year(beginning_of_follow_up) %in% 2006:2011) ~ "2006-2011",
  (year(beginning_of_follow_up) %in% 2012:2017) ~ "2012-2017",
  (year(beginning_of_follow_up) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  select(rescue_medication_yes_no, number_rescue_medications, age_first_febrile_seizure, female, number_febrile_seizures, type_febrile_seizure_1, type_febrile_seizure_encounter_1, eventual_epilepsy, number_encounters, number_emergency_encounters, number_inpatient_encounters, year_first_febrile_seizure, rural, region_category, employment_status_category, employment_class_category) %>% collect()
```




Factors associated with at least a prescription of rescue benzodiazepine
```{r}
# Regression on rescue medication
logistic_regression_rescue_medication <- glm(rescue_medication_yes_no ~ age_first_febrile_seizure + female +   relevel(type_febrile_seizure_1, ref = "simple") + type_febrile_seizure_encounter_1 + year_first_febrile_seizure + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = febrile_seizure_data_for_regression, family = "binomial")

summary(logistic_regression_rescue_medication)

exp(cbind(OR=coef(logistic_regression_rescue_medication), confint(logistic_regression_rescue_medication)))
```




Factors associated with the number of prescriptions of rescue benzodiazepine
```{r}
# Regression on number of rescue medications
linear_regression_rescue_medication_number <- lm(number_rescue_medications ~ age_first_febrile_seizure + female + number_febrile_seizures + relevel(type_febrile_seizure_1, ref = "simple") + type_febrile_seizure_encounter_1 + eventual_epilepsy + number_encounters + number_emergency_encounters + number_inpatient_encounters + year_first_febrile_seizure + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = febrile_seizure_data_for_regression)

summary(linear_regression_rescue_medication_number)

confint(linear_regression_rescue_medication_number, level = 0.95)
```




Time to prescriptions of rescue benzodiazepine
```{r}
# Time to rescue medication
time_to_rescue <- febrile_seizure_data %>% 
  mutate(time_to_rescue_medication = as.numeric(date_rescue_medication_1 - date_febrile_seizure_1)) %>% 
  summarize(
    median_time = median(time_to_rescue_medication, na.rm=TRUE),
    p25_time = quantile(time_to_rescue_medication, 0.25, na.rm=TRUE),
    p75_time = quantile(time_to_rescue_medication, 0.75, na.rm=TRUE),
    mean_time = mean(time_to_rescue_medication, na.rm=TRUE),
    SD_time = sd(time_to_rescue_medication, na.rm=TRUE)  
  ) %>% 
  collect()
time_to_rescue




first_rescue_no_new_seizures_no_new_encounters_no_new_epilepsy <- febrile_seizure_data %>% 
  mutate(no_new_seizures_no_new_encounters_no_new_epilepsy = case_when(
  (is.na(date_febrile_seizure_2) | (date_febrile_seizure_2 > date_rescue_medication_1)) & 
  (is.na(febrile_seizure_emergency_encounter_1) |  (febrile_seizure_emergency_encounter_1 > date_rescue_medication_1)) &
  (is.na(febrile_seizure_inpatient_encounter_1) |  (febrile_seizure_inpatient_encounter_1 > date_rescue_medication_1)) &
  (is.na(first_code_epilepsy) |  (first_code_epilepsy > date_rescue_medication_1)) ~ "yes",
  TRUE ~ "no")) %>% 
  reframe(
  no_new_seizures_no_new_encounters_no_new_epilepsy = CrossTable(no_new_seizures_no_new_encounters_no_new_epilepsy)
)




# Long delay to rescue medication prescription
long_time_to_rescue_data <- febrile_seizure_data %>% 
  mutate(time_to_rescue_medication = as.numeric(date_rescue_medication_1 - date_febrile_seizure_1)) %>% 
  mutate(long_time_to_rescue = case_when(
    time_to_rescue_medication > 30 ~ "yes",
    TRUE ~ "no"
    )) %>% 
  filter(long_time_to_rescue=="yes") %>% 
  mutate(no_new_febrile_seizure = case_when(
    (is.na(date_febrile_seizure_2) | (date_febrile_seizure_2 > date_rescue_medication_1)) ~ "yes",
    TRUE ~ "no"
  )) %>% 
  mutate(no_new_emergency = case_when(
    (is.na(febrile_seizure_emergency_encounter_1) |  (febrile_seizure_emergency_encounter_1 > date_rescue_medication_1)) ~ "yes",
    TRUE ~ "no"
  )) %>% 
  mutate(no_new_hospitalization = case_when(
    (is.na(febrile_seizure_inpatient_encounter_1) |  (febrile_seizure_inpatient_encounter_1 > date_rescue_medication_1)) ~ "yes",
    TRUE ~ "no"
  )) %>% 
  mutate(no_epilepsy = case_when(
    (is.na(first_code_epilepsy) |  (first_code_epilepsy > date_rescue_medication_1)) ~ "yes",
    TRUE ~ "no"
  )) %>% 
  collect()

CrossTable(long_time_to_rescue_data$no_new_febrile_seizure)

CrossTable(long_time_to_rescue_data$no_new_emergency)

CrossTable(long_time_to_rescue_data$no_new_hospitalization)

CrossTable(long_time_to_rescue_data$no_epilepsy)
```




Database for Cox regression
```{r}
# Modify database for Cox regression
# https://stats.oarc.ucla.edu/r/examples/alda/r-applied-longitudinal-data-analysis-ch-15/
febrile_seizure_data_for_Cox_regression <- febrile_seizure_data %>% 
  mutate(rescue_medication_yes_no = as.factor(rescue_medication_yes_no)) %>% 
  mutate(female = as.factor(case_when(
  SEX == 2 ~ "yes",
  TRUE ~ "no"))) %>% 
  mutate(type_febrile_seizure_1 = as.factor(type_febrile_seizure_1)) %>% 
  mutate(type_febrile_seizure_encounter_1 = as.factor(type_febrile_seizure_encounter_1)) %>% 
  mutate(eventual_epilepsy = as.factor(eventual_epilepsy)) %>% 
  mutate(year_first_febrile_seizure = case_when(
  (year(beginning_of_follow_up) %in% 2006:2011) ~ "2006-2011",
  (year(beginning_of_follow_up) %in% 2012:2017) ~ "2012-2017",
  (year(beginning_of_follow_up) %in% 2018:2022) ~ "2018-2022")) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  select(ENROLID, rescue_medication_yes_no, number_rescue_medications, age_first_febrile_seizure, female, number_febrile_seizures, type_febrile_seizure_1, type_febrile_seizure_encounter_1, eventual_epilepsy, number_encounters, number_emergency_encounters, number_inpatient_encounters, year_first_febrile_seizure, rural, region_category, employment_status_category, employment_class_category, date_rescue_medication_1, date_febrile_seizure_1, date_febrile_seizure_2, first_code_epilepsy, febrile_seizure_emergency_encounter_2, febrile_seizure_inpatient_encounter_2, length_of_follow_up) %>% 
  mutate(time_to_first_rescue_medication = case_when(
  rescue_medication_yes_no == "yes" ~ as.numeric(date_rescue_medication_1 - date_febrile_seizure_1),
  TRUE ~ length_of_follow_up)) %>% 
  mutate(rescue_medication_event = case_when(
  rescue_medication_yes_no == "yes" ~ 1,
  TRUE ~ 0)) %>% 
  mutate(time_to_second_seizure = case_when(
  (!is.na(date_febrile_seizure_2)) ~ as.numeric(date_febrile_seizure_2 - date_febrile_seizure_1),
  TRUE ~ length_of_follow_up)) %>% 
  mutate(second_seizure_event = case_when(
  (!is.na(date_febrile_seizure_2)) ~ 1,
  TRUE ~ 0)) %>% 
  mutate(time_to_epilepsy = case_when(
  !is.na(first_code_epilepsy) ~ as.numeric(first_code_epilepsy - date_febrile_seizure_1),
  TRUE ~ length_of_follow_up)) %>% 
  mutate(epilepsy_event = case_when(
  (!is.na(first_code_epilepsy)) ~ 1,
  TRUE ~ 0)) %>%
  select(ENROLID, time_to_first_rescue_medication, rescue_medication_event, time_to_second_seizure, second_seizure_event, time_to_epilepsy, epilepsy_event, age_first_febrile_seizure, female, type_febrile_seizure_1, type_febrile_seizure_encounter_1, year_first_febrile_seizure, rural, region_category, employment_status_category, employment_class_category) %>% 
  filter(time_to_first_rescue_medication > 0) %>% 
  collect()
  



# Long dataset for Cox regression with time-varying variables
long_febrile_seizure_data_for_Cox_regression <- tmerge(febrile_seizure_data_for_Cox_regression, febrile_seizure_data_for_Cox_regression,
  id = ENROLID,
  time_to_rescue_medication = event(time_to_first_rescue_medication, rescue_medication_event),
  second_seizure = tdc(time_to_second_seizure),
  epilepsy_diagnosis = tdc(time_to_epilepsy)) %>%
  select(ENROLID, time_to_rescue_medication, tstart, tstop, second_seizure, epilepsy_diagnosis, age_first_febrile_seizure, female, type_febrile_seizure_1, type_febrile_seizure_encounter_1, year_first_febrile_seizure, rural, region_category, employment_status_category, employment_class_category) %>% 
  collect()
```




Cox regression
```{r}
# Cox regression on time to first rescue medication
Cox_regression_time_to_rescue_medication <- coxph(Surv(tstart, tstop, time_to_rescue_medication) ~ second_seizure + epilepsy_diagnosis + age_first_febrile_seizure + female + relevel(type_febrile_seizure_1, ref = "simple") + type_febrile_seizure_encounter_1 + year_first_febrile_seizure + rural + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = long_febrile_seizure_data_for_Cox_regression, ties = "efron")

summary(Cox_regression_time_to_rescue_medication)
```








## 5. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

